<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Kółko i krzyżyk 2">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Access-Control-Allow-Origin" content="modalLocal.html">

    <link rel="icon" type="image/x-icon" href="../resources/icon.ico">
    <title>Kółko i krzyżyk 2</title>
    <link rel="stylesheet" href="style.css">

    <script>
        function changeFillColor(){
            const preview = document.getElementById("previewFill");
            preview.style.backgroundColor = document.getElementById("fillColor").value;
            preview.style.opacity = (document.getElementById("fillAlpha").value/100);
        }
        function changeLineColor(){
            const preview = document.getElementById("previewLine");
            preview.style.backgroundColor = document.getElementById("lineColor").value;
            preview.style.opacity = (document.getElementById("lineAlpha").value/100);
        }

        window.onload = function() {
            changeFillColor();
            changeLineColor();
        }
    </script>
</head>
<body>
    <header>
        <img src="../resources/ikona2.png" alt="Nie udało się załadować ikony">
        <h1>Kółko i krzyżyk 2</h1>
        <nav>
            <button id="howToButton">Jak grać</button> 
            <div class="line"></div>
            <button id="controlButton">Sterowanie</button> 
            <div class="line"></div>
            <button id="resultsButton">Wyniki</button> 
        </nav>
    </header>
    <main>
        <section></section>
        <canvas id="canvas"></canvas>
        <aside>
            <div class="styleContainer">
                <label for="fillColor">Kolor wypełnienia: </label>
                <input type="color" name="fillColor" id="fillColor" value="#00005A" onchange="changeFillColor()"><br>
                <div class="colorPreview" id="previewFill"></div>
                <input type="range" name="fillAlpha" id="fillAlpha" min="0" max="100" onchange="changeFillColor()">
            </div>
            <div class="styleContainer">
                <label for="lineColor">Kolor linii: </label>
                <input type="color" name="lineColor" id="lineColor" value="#000064" onchange="changeLineColor()"><br>
                <div class="colorPreview" id="previewLine"></div>
                <input type="range" name="lineAlpha" id="lineAlpha" min="0" max="100" onchange="changeLineColor()">
            </div>
            <div class="styleContainer">
                <label for="lineWidth">Grubość linii: </label>
                <input type="number" name="lineWidth" id="lineWidth" value="1" min="0" max="10"><br>
            </div>
            <div class="styleContainer">
                <label for="precision">Precyzja: </label>
                <input type="range" name="precision" id="precision" min="4" max="30"><br>
            </div>
            <button id="apply">Zastosuj</button>
            <button id="ping">Ping</button>
            <input type="text" id="cmd">
        </aside>
    </main>
    <footer>
        Adam Stachowicz 2024
    </footer>
   
    <div id="howToWrapper" class="modalWrapper"> <iframe src="../modals/modalHowTo.html" title="howToPlay"></iframe> </div>
    <div id="controlWrapper" class="modalWrapper"> <iframe src="../modals/modalControl.html" title="control"></iframe> </div>
</body>
</html>

<script type="module">
    import Board from "../engine/Board.js";
    import { rgbToColor } from "../engine/Objects/Color.js";

    let address = "localhost";
    let port = "3310";
    let connectAgain = false;  // Flaga dla eventu onclose
    let action = "host";
    const canvas = document.getElementById("canvas");
    const board = new Board(canvas, canvas.offsetWidth, canvas.offsetHeight, 4, 4, 4, 70, 14, 3);

    let formData = JSON.parse(sessionStorage.getItem("hostData"));
    if(formData === null){
        formData = JSON.parse(sessionStorage.getItem("joinData"));
        action = "join";
    }
    if(formData === null){
        formData = JSON.parse(sessionStorage.getItem("localData"));
        action = "local";
    }
    console.log(formData);
    console.log(document.location);

    window.addEventListener("resize", () => board.resize());
    document.getElementById("howToButton").onclick = function(){ document.getElementById("howToWrapper").style.display = "block"; };
    document.getElementById("controlButton").onclick = function(){ document.getElementById("controlWrapper").style.display = "block"; };
    document.getElementById("resultsButton").onclick = function(){ document.location.href = "../results"; }
    document.getElementById("apply").onclick = function(){
        board.setFieldsStyle(
            rgbToColor(document.getElementById("fillColor").value),
            rgbToColor(document.getElementById("lineColor").value),
            document.getElementById("lineWidth").value
        );
    }
    window.addEventListener("message", function(event) {
        if(event.data === "closeModal"){
            document.getElementById("howToWrapper").style.display = "none"; 
            document.getElementById("controlWrapper").style.display = "none";  
        }
    });
    document.getElementById("canvas").addEventListener("dblclick", () =>{ console.log(board.chosenField); });

    if(!formData) return;
    document.getElementById("ping").onclick = function(){ sendMessage(document.getElementById("cmd").value); }
    if(!formData.port) port = formData.port;

    let socket = new WebSocket(`ws://${address}:${port}`);
    console.log("stan: ", socket.readyState);
    socket.onopen = function() { 
        console.log('Połączono'); 
        if(action === "host") socket.send("Create " + formData.nOfPlayers + " " + formData.sizes + " " + formData.target); 
        if(action === "join") socke.send("SetNick " + formData.nick);
    };

    socket.onmessage = onMessage(event.data);
    socket.onclose = function() { onClose(); };
    
    function sendMessage(msg) { socket.send(msg); console.log("stan: ", socket.readyState);}
    function onMessage(msg){
        console.log(`Otrzymano: ${msg}`); 
        if(!msg || msg == "") return;
        const args = event.data.split(" ");

        switch(args[0].toLowerCase()){
            case "port":
                if(!args[1]){
                    console.log("Nie podano portu.");
                    return;
                }
                port = args[1];
                connectAgain = true;
                socket.close();
                break;

            case "refresh": break;
            case "won": break;
            case "joined": break;
            case "left": break;
            case "closed": break;
            case "paused": break;
            case "unpaused": break;
            case "error": break;
            case "ping": socket.send("Reping"); break;
            case "reping": console.log("Reping"); break;
            default: console.log("Incorrect message: " + msg); break;
        }
    }

    function onClose(){
        console.log("stan: ", socket.readyState);
        console.log('Rozłączono'); 
        if (connectAgain) {
            connectAgain = false;
            socket = new WebSocket(`ws://${address}:${port}`);

            socket.onopen = function() { console.log("Połączono ponownie!"); };
            socket.onmessage = function(event) { onMessage(event.data); };
            socket.onclose = function() { onClose(); };
        }
        console.log("stan: ", socket.readyState);
    }

</script>